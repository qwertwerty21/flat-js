!function(){if(null===flat||"object"!=typeof flat||"function"!=typeof flat.load)throw new Error("flat/api: missing flat-js");if(!jQuery)throw new Error("flat/api: missing jQuery");flat.load("api",function(){var base_url=flat.base_url,pub={};return pub.api_base_url=base_url+"/api.php",pub.get_url=function(request){if(flat.is_string(request))return pub.api_base_url+"/"+request},pub.cannot_get_path=function(url,reason){var pub={};if(reason=reason?"reason: "+reason:"",!url)var url="";return pub.url=url,pub.toString=function(){return"could not get a path from given url"+reason},pub.name="cannot_get_path",pub.message=pub.toString,pub},pub.cannot_get_ref=function(url,reason){var pub={};if(reason=reason?"reason: "+reason:"",!url)var url="";return pub.url=url,pub.toString=function(){return"could not get a path from given url"+reason},pub.name="cannot_get_ref",pub.message=pub.toString,pub},pub.props_arg_invalid=function(){var pub={};return pub.toString=function(){return"props arg is not object"},pub.name="props_arg_invalid",pub.message=pub.toString,pub},pub.response_not_object=function(){var pub={};return pub.toString=function(){return"response is not object"},pub.name="response_not_object",pub.message=pub.toString,pub},pub.missing_expected_property=function(property){if("string"!=typeof property&&!(property instanceof String))throw"property arg must be string";var pub={};return pub.get_property=function(){return property},pub.toString=function(){return"response missing property: "+property},pub.name="missing_expected_property",pub.message=pub.toString,pub},pub.url_to_path=function(url){var idx;if(url||(url=flat.get_url()),!url)throw pub.cannot_get_path(url,"url arg not given and no environmental url");if((idx=url.lastIndexOf(search="flat.php/"))<0&&(idx=url.lastIndexOf(search="api.php/"))<0)throw pub.cannot_get_path(url,"could not find flat sub path in url");return idx+=search.length,url.substr(idx)},pub.url_to_ref=function(url,path){var chunk,ref;if(url||(url=flat.get_url()),!path){if("/"==url.substr(-1)){for(chunk=url.split("/"),i=chunk.length;i>=0;i<i--)if(chunk[i]){ref=chunk[i];break}}else ref=url.substr(url.lastIndexOf("/")+1);return ref}if(!url.indexOf(path))throw pub.cannot_get_ref(url,"missing path string that can be found in given url");return pub.url_to_path(url).substr(path.length*-1)},pub.is_valid_response=function(params,response){if(!flat.is_object(response))throw pub.response_not_object;if(params.props)try{pub.check_response_props(params.props,response)}catch(e){if(e==pub.props_arg_invalid)throw e;if(e==pub.missing_expected_property)return log("response missing property: "+e.get_property()),!1;throw e}},pub.check_response_props=function(props,response){if(!flat.is_array(props))throw pub.props_arg_invalid;if(!flat.is_object(response))throw pub.response_not_object;for(i=0;i<props.length;i++)if(!response[props[i]])throw pub.missing_expected_property(props[i])},pub.request=function(path_or_params,data_or_callback,callback_if_data){var params={path:"",url:"",type:"GET",data:"",callback:"",success:null,error:null,always:null,response_properties:"",send_JSON:!0,headers:null},param_arg=!1;if(1==arguments.length&&flat.is_object(path_or_params))for(var prop in path_or_params)path_or_params.hasOwnProperty(prop)&&params.hasOwnProperty(prop)&&(param_arg=!0,params[prop]=path_or_params[prop]);param_arg||(params.path=path_or_params,flat.is_func(data_or_callback)?params.callback=data_or_callback:data_or_callback&&(flat.is_func(data_or_callback)?params.callback=data_or_callback:(params.data=data_or_callback,flat.is_func(callback_if_data)&&(params.callback=callback_if_data))));var callback;params.callback&&flat.is_func(params.callback)&&(callback=params.callback);var url="";if(params.url&&(url=params.url),url||(params.path?url=pub.get_url(params.path):path_or_params&&(url=pub.get_url(path_or_params))),!url)throw"cannot_determine_url";var conf={url:url,type:params.type.toUpperCase(),timeout:3e4,async:!0};params.data&&(params.send_JSON&&"GET"!=conf.type?(conf.data=JSON.stringify(params.data),conf.contentType="application/json; charset=UTF-8"):conf.data=params.data),params.headers&&flat.isObject(params.headers)&&(conf.headers=params.headers),$.ajax(conf).always(function(response,status){var data={};if(flat.is_object(response))if(response.responseJSON)response=response.responseJSON,data=response.data?response.data:response;else if(response.responseXML){var etop,xmlDoc=response.responseXML,rns="https://github.com/katmore/flat/wiki/xmlns",edata=xmlDoc.getElementsByTagNameNS(rns,"data");if(edata.length){etop=edata[0];var meta=etop.getAttributeNS(rns,"meta");if(meta&&"flat\\error_collection"==meta){var errnode=etop.getElementsByTagNameNS(rns+"-object","error");if(errnode&&errnode.length){var errdata=errnode[0].getElementsByTagNameNS(rns,"data");if(errdata&&errdata.length)for(var prop=["type","message","name","code"],i=0;i<prop.length;i++){var pval=errdata[0].getElementsByTagNameNS(rns+"-object",prop[i]);pval&&pval.length&&pval[0].childNodes&&pval[0].childNodes.length&&(data[prop[i]]=pval[0].childNodes[0].nodeValue)}}}}}else data=response.data?response.data:response;else data=response,response={status:status},flat.is_string(data)&&(response.data=data);if("success"==status?data&&response.checksum&&response.status&&response.status_code&&params.success&&flat.is_func(params.success)&&params.success(data,{status:response.status,code:response.status_code},response.checksum):params.error&&flat.is_func(params.error)&&(data&&data.message&&flat.is_string(data.message)?params.error(data.message,data,response):(console.log("WARNING: response is missing error message field"),params.error(status,data,response))),callback||flat.is_func(params.always))callback&&callback(data,status,response),flat.is_func(params.always)&&params.always(data,status,response);else if("success"!=status){if(params.error&&flat.is_func(params.error))return;throw data&&data.message?data.message:"request"}})},pub}())}();
